// ==UserScript==
// @name         Stake Code Auto Claimer Top Bar
// @namespace    http://tampermonkey.net/
// @version      3.11
// @description  Top bar interface with improved claiming - UI unchanged
// @author       StakeBot
// @match        https://stake.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @connect      localhost
// @connect      127.0.0.1
// ==/UserScript==

(function() {
    'use strict';

    // Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ø¨ÙˆØª Ø§Ù„ØªÙ„ØºØ±Ø§Ù…
    const SCRIPT_TOKEN = "..............";
    const SERVER_URL = "http://127.0.0.1:5000";
    // Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ«Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø§Ø­Ù‚Ø§Ù‹
    const USERNAME = ".........";

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    let isClaiming = false;
    let claimHistory = [];
    let autoClaimEnabled = false;
    let soundEnabled = true;

    // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ù†Ù…Ø§Ø· CSS Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„)
    function createTopBarStyles() {
        GM_addStyle(`
            /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ */
            #stake-top-toolbar {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                background: linear-gradient(90deg, #0d1b2a, #1b263b);
                color: #e0f7fa;
                padding: 8px 15px;
                z-index: 10001;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                box-shadow: 0 2px 10px rgba(0,0,0,0.5);
                border-bottom: 2px solid #4caf50;
                backdrop-filter: blur(10px);
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 12px;
                font-size: 12px;
            }

            /* ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø£Ø³ÙÙ„ */
            body {
                padding-top: 45px !important;
                margin-top: 0 !important;
            }

            #stake-toolbar-left {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            #stake-toolbar-right {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .toolbar-section {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .toolbar-user-info {
                background: rgba(76, 175, 80, 0.2);
                padding: 4px 10px;
                border-radius: 15px;
                border: 1px solid #4caf50;
                font-size: 11px;
                font-weight: 600;
                color: #4caf50;
            }

            .toolbar-title {
                font-size: 16px;
                font-weight: bold;
                color: #4caf50;
                text-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .toolbar-btn {
                background: linear-gradient(45deg, #2196f3, #1976d2);
                color: white;
                border: none;
                padding: 5px 12px;
                border-radius: 15px;
                cursor: pointer;
                font-size: 11px;
                font-weight: 600;
                transition: all 0.2s ease;
                border: 1px solid rgba(255,255,255,0.2);
                white-space: nowrap;
                box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            }

            .toolbar-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            }

            .toolbar-btn.success {
                background: linear-gradient(45deg, #4caf50, #388e3c);
            }

            .toolbar-btn.danger {
                background: linear-gradient(45deg, #f44336, #d32f2f);
            }

            .toolbar-btn.warning {
                background: linear-gradient(45deg, #ff9800, #f57c00);
            }

            .status-indicator-top {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: #f44336;
                display: inline-block;
                box-shadow: 0 0 5px rgba(244, 67, 54, 0.3);
            }

            .status-indicator-top.active {
                background: #4caf50;
                box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
            }

            .status-indicator-top.claiming {
                background: #ff9800;
                animation: pulse 1s infinite;
                box-shadow: 0 0 5px rgba(255, 152, 0, 0.3);
            }

            @keyframes pulse {
                0% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.7; transform: scale(1.1); }
                100% { opacity: 1; transform: scale(1); }
            }

            .toolbar-toggle {
                position: relative;
                display: inline-block;
                width: 30px;
                height: 16px;
            }

            .toolbar-toggle input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .toolbar-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .3s;
                border-radius: 16px;
            }

            .toolbar-slider:before {
                position: absolute;
                content: "";
                height: 12px;
                width: 12px;
                left: 2px;
                bottom: 2px;
                background-color: white;
                transition: .3s;
                border-radius: 50%;
            }

            input:checked + .toolbar-slider {
                background-color: #2196F3;
            }

            input:checked + .toolbar-slider:before {
                transform: translateX(14px);
            }

            .toolbar-status-text {
                font-size: 11px;
                font-weight: 500;
                white-space: nowrap;
                color: #e0f7fa;
            }

            .toolbar-history {
                position: absolute;
                top: 45px;
                left: 15px;
                background: #1b263b;
                color: #e0f7fa;
                padding: 15px;
                border-radius: 8px;
                z-index: 10000;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                box-shadow: 0 4px 15px rgba(0,0,0,0.4);
                border: 1px solid #4caf50;
                min-width: 280px;
                max-width: 400px;
                max-height: 300px;
                overflow-y: auto;
                display: none;
                font-size: 11px;
            }

            .history-item-top {
                padding: 8px;
                border-bottom: 1px solid rgba(255,255,255,0.15);
                font-size: 10px;
            }

            .history-item-top:last-child {
                border-bottom: none;
            }

            .code-value-top {
                color: #4caf50;
                font-weight: 600;
                font-size: 11px;
            }

            #close-history-top {
                background: #f44336;
                border: none;
                color: white;
                cursor: pointer;
                font-size: 14px;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
            }

            /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
            @media (max-width: 768px) {
                #stake-top-toolbar {
                    flex-direction: column;
                    gap: 8px;
                    padding: 6px 10px;
                    font-size: 11px;
                }

                body {
                    padding-top: 80px !important;
                }

                #stake-toolbar-left, #stake-toolbar-right {
                    width: 100%;
                    justify-content: center;
                    flex-wrap: wrap;
                }

                .toolbar-title {
                    font-size: 14px;
                }

                .toolbar-btn {
                    padding: 4px 10px;
                    font-size: 10px;
                }

                .toolbar-history {
                    top: 80px;
                    left: 10px;
                    padding: 12px;
                    font-size: 10px;
                }
            }
        `);
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙˆÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„)
    function createTopToolbar() {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ù† Ù‚Ø¨Ù„
        if (document.getElementById('stake-top-toolbar')) {
            return;
        }

        const toolbar = document.createElement('div');
        toolbar.id = 'stake-top-toolbar';
        toolbar.innerHTML = `
            <div id="stake-toolbar-left">
                <span class="toolbar-title">ğŸ¤– Stake Claimer</span>
                <span class="toolbar-user-info">ğŸ‘¤ ${USERNAME}</span>
                <span id="top-status-indicator" class="status-indicator-top"></span>
                <span id="top-status-text" class="toolbar-status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</span>
            </div>

            <div id="stake-toolbar-right">
                <button id="manual-check-top" class="toolbar-btn">ğŸ” ÙØ­Øµ</button>
                <button id="turbo-claim-top" class="toolbar-btn danger">ğŸš€ Turbo</button>

                <div class="toolbar-section">
                    <span style="font-size: 11px; font-weight: 600;">ğŸ”Š:</span>
                    <button id="toggle-sound-top" class="toolbar-btn">Ù…ÙØ¹Ù„</button>
                </div>

                <div class="toolbar-section">
                    <span style="font-size: 11px; font-weight: 600;">âš¡:</span>
                    <label class="toolbar-toggle">
                        <input type="checkbox" id="auto-claim-toggle-top">
                        <span class="toolbar-slider"></span>
                    </label>
                    <button id="toggle-auto-claim-top" class="toolbar-btn warning">ØªÙØ¹ÙŠÙ„</button>
                </div>

                <button id="show-history-top" class="toolbar-btn">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„</button>
            </div>
        `;

        document.body.insertBefore(toolbar, document.body.firstChild);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        document.getElementById('manual-check-top').addEventListener('click', checkForNewCodes);
        document.getElementById('turbo-claim-top').addEventListener('click', turboClaim);
        document.getElementById('toggle-sound-top').addEventListener('click', toggleSound);
        document.getElementById('auto-claim-toggle-top').addEventListener('change', function() {
            autoClaimEnabled = this.checked;
            updateAutoClaimButton();
        });
        document.getElementById('toggle-auto-claim-top').addEventListener('click', toggleAutoClaim);
        document.getElementById('show-history-top').addEventListener('click', showHistory);
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø¬Ù„ (Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„)
    function createHistoryPanel() {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ù† Ù‚Ø¨Ù„
        if (document.getElementById('toolbar-history-panel')) {
            return;
        }

        const historyPanel = document.createElement('div');
        historyPanel.id = 'toolbar-history-panel';
        historyPanel.className = 'toolbar-history';
        historyPanel.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong style="font-size: 13px; color: #4caf50;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª</strong>
                <button id="close-history-top">âœ•</button>
            </div>
            <div id="history-content-top" style="font-size: 10px;"></div>
        `;

        document.body.appendChild(historyPanel);

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø³Ø¬Ù„
        document.getElementById('close-history-top').addEventListener('click', hideHistory);
    }

    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    function updateAutoClaimButton() {
        const toggleBtn = document.getElementById('toggle-auto-claim-top');
        const checkbox = document.getElementById('auto-claim-toggle-top');

        if (toggleBtn && checkbox) {
            checkbox.checked = autoClaimEnabled;
            toggleBtn.textContent = autoClaimEnabled ? 'Ø¥ÙŠÙ‚Ø§Ù' : 'ØªÙØ¹ÙŠÙ„';
            toggleBtn.className = autoClaimEnabled ? 'toolbar-btn success' : 'toolbar-btn warning';
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø£ØµÙˆØ§Øª
    function updateSoundButton() {
        const soundBtn = document.getElementById('toggle-sound-top');
        if (soundBtn) {
            soundBtn.textContent = soundEnabled ? 'Ù…ÙØ¹Ù„' : 'Ù…Ø¹Ø·Ù„';
            soundBtn.className = soundEnabled ? 'toolbar-btn' : 'toolbar-btn danger';
        }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
    function updateStatus(text, status = 'normal') {
        const statusText = document.getElementById('top-status-text');
        const indicator = document.getElementById('top-status-indicator');

        if (statusText) statusText.textContent = text;

        if (indicator) {
            indicator.className = 'status-indicator-top';
            if (status === 'active') indicator.classList.add('active');
            if (status === 'claiming') indicator.classList.add('claiming');
        }
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø§Øª
    function addToHistory(code, value, status) {
        claimHistory.unshift({
            code: code,
            value: value,
            status: status,
            timestamp: new Date()
        });

        if (claimHistory.length > 50) {
            claimHistory.pop();
        }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„
    function showHistory() {
        const historyPanel = document.getElementById('toolbar-history-panel');
        const historyContent = document.getElementById('history-content-top');

        if (historyPanel && historyContent) {
            historyPanel.style.display = 'block';

            if (claimHistory.length === 0) {
                historyContent.innerHTML = '<div style="text-align: center; color: #90a4ae; padding: 15px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</div>';
            } else {
                historyContent.innerHTML = claimHistory.map(item => `
                    <div class="history-item-top">
                        <div><strong style="font-size: 11px;">${item.code}</strong> - <span class="code-value-top">$${item.value}</span></div>
                        <div style="color: ${item.status === 'success' ? '#4caf50' : '#f44336'}; font-size: 9px; margin-top: 3px;">
                            ${item.status === 'success' ? 'âœ… Ù†Ø¬Ø­' : 'âŒ ÙØ´Ù„'} - ${item.timestamp.toLocaleTimeString('ar-SA')}
                        </div>
                    </div>
                `).join('');
            }
        }
    }

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„
    function hideHistory() {
        const historyPanel = document.getElementById('toolbar-history-panel');
        if (historyPanel) {
            historyPanel.style.display = 'none';
        }
    }

    // ØªÙØ¹ÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    function toggleAutoClaim() {
        autoClaimEnabled = !autoClaimEnabled;
        updateAutoClaimButton();

        if (autoClaimEnabled) {
            updateStatus('Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…ÙØ¹Ù„Ø©', 'active');
            playSound('auto_claim_enabled');
        } else {
            updateStatus('Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹Ø·Ù„Ø©');
        }
    }

    // ØªÙØ¹ÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø£ØµÙˆØ§Øª
    function toggleSound() {
        soundEnabled = !soundEnabled;
        updateSoundButton();
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
    function playSound(type) {
        if (!soundEnabled) return;

        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            switch(type) {
                case 'new_code':
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.type = 'sine';
                    break;
                case 'success':
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                    oscillator.type = 'sine';
                    break;
                case 'error':
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.type = 'square';
                    break;
                case 'auto_claim_enabled':
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                    oscillator.type = 'sine';
                    break;
            }

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.2);
        } catch (e) {
            console.log('ğŸ”Š Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', e);
        }
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ù…Ø²
    function validateToken() {
        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                method: 'POST',
                url: `${SERVER_URL}/api/validate-token`,
                headers: {
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    token: SCRIPT_TOKEN
                }),
                onload: function(response) {
                    try {
                        const data = JSON.parse(response.responseText);
                        if (data.valid) {
                            resolve(true);
                        } else {
                            reject(new Error(data.message || 'Ø±Ù…Ø² ØºÙŠØ± ØµØ§Ù„Ø­'));
                        }
                    } catch (e) {
                        reject(e);
                    }
                },
                onerror: function(error) {
                    reject(new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±'));
                }
            });
        });
    }

    // ÙØ­Øµ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    function checkForNewCodes() {
        if (isClaiming) {
            updateStatus('Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø©...', 'claiming');
            return;
        }

        updateStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...', 'claiming');

        GM_xmlhttpRequest({
            method: 'GET',
            url: `${SERVER_URL}/api/codes/pending`,
            headers: {
                'Script-Token': SCRIPT_TOKEN,
                'Content-Type': 'application/json'
            },
            onload: function(response) {
                try {
                    if (response.status === 401) {
                        updateStatus('Ø§Ø´ØªØ±Ø§Ùƒ ØºÙŠØ± Ù…ÙØ¹Ù„', 'error');
                        playSound('error');
                        alert('âŒ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ØºÙŠØ± Ù…ÙØ¹Ù„ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡.');
                        return;
                    }

                    const data = JSON.parse(response.responseText);
                    if (data.length > 0) {
                        playSound('new_code');
                        processCode(data[0]);
                    } else {
                        updateStatus('Ù…ØªØµÙ„ - Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯', 'active');
                    }
                } catch (e) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', e);
                    updateStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                    playSound('error');
                }
            },
            onerror: function(error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±:', error);
                updateStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
                playSound('error');
            }
        });
    }

    // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø´ÙƒÙ„ ÙØ¹Ù„ÙŠ (Ù…Ø­Ø³Ù‘Ù†Ø©)
    function simulateCodeEntry(code) {
        return new Promise((resolve, reject) => {
            console.log(`ğŸ¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯: ${code}`);

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù‚Ø³Ù… (Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…)
            let codeInput = null;
            const inputs = Array.from(document.querySelectorAll('input[name="code"]'));

            for (const inp of inputs) {
                const section = inp.closest('section') || inp.closest('div');
                if (section && section.innerText.includes("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª")) {
                    codeInput = inp;
                    break;
                }
            }

            // Ø¥Ø°Ø§ Ù…Ø§ Ù„Ù‚Ù‰ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…ØŒ ÙŠØ¬Ø±Ø¨ Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            if (!codeInput) {
                const inputSelectors = [
                    'input[placeholder*="code"]',
                    'input[placeholder*="ÙƒÙˆØ¯"]',
                    'input[name*="code"]',
                    'input[id*="code"]',
                    'input[type="text"]'
                ];

                for (let selector of inputSelectors) {
                    const inputs = document.querySelectorAll(selector);
                    for (let input of inputs) {
                        if (input.offsetParent !== null && !input.disabled && !input.readOnly) {
                            codeInput = input;
                            break;
                        }
                    }
                    if (codeInput) break;
                }
            }

            if (codeInput) {
                // Ù…Ø³Ø­ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ø³Ø§Ø¨Ù‚Ø©
                codeInput.value = '';

                // ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒÙˆØ¯
                codeInput.focus();
                codeInput.value = code;

                // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ­Ø³ Ø¨Ø§Ù„ØªØºÙŠÙŠØ±
                codeInput.dispatchEvent(new Event('input', { bubbles: true }));
                codeInput.dispatchEvent(new Event('change', { bubbles: true }));

                console.log(`âœ… ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„:`, codeInput);

                // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠØ¹Ø§Ù„Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                setTimeout(() => {
                    resolve(codeInput);
                }, 500);
            } else {
                console.error('âŒ Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§ Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯');
                reject(new Error('Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§ Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯'));
            }
        });
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    function clickSubmitButton() {
        return new Promise((resolve) => {
            console.log('ğŸ‘† Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø²Ø± "Ø¥Ø±Ø³Ø§Ù„" ÙÙŠ Ù‚Ø³Ù… "ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª" (Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…)
            const allButtons = Array.from(document.querySelectorAll('button'));
            const sendButtons = allButtons.filter(btn =>
                btn.innerText && btn.innerText.trim() === "Ø¥Ø±Ø³Ø§Ù„"
            );

            let submitButton = null;
            for (const btn of sendButtons) {
                const section = btn.closest('section') || btn.closest('div');
                if (section && section.innerText.includes("ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª")) {
                    submitButton = btn;
                    break;
                }
            }

            // Ø¥Ø°Ø§ Ù…Ø§ Ù„Ù‚Ù‰ Ø§Ù„Ø²Ø± Ø­Ø³Ø¨ Ø§Ù„Ù†ØµØŒ ÙŠØ¬Ø±Ø¨ Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            if (!submitButton) {
                const submitSelectors = [
                    'button[type="submit"]',
                    'button[class*="submit"]',
                    'button[class*="claim"]',
                    'button[class*="send"]',
                    'button'
                ];

                for (let selector of submitSelectors) {
                    const buttons = document.querySelectorAll(selector);
                    for (let button of buttons) {
                        const text = (button.textContent || button.innerText || '').toLowerCase();
                        if (button.offsetParent !== null &&
                            (text.includes('submit') || text.includes('Ø¥Ø±Ø³Ø§Ù„') ||
                             text.includes('claim') || text.includes('Ù…Ø·Ø§Ù„Ø¨Ø©') ||
                             text.includes('send'))) {
                            submitButton = button;
                            break;
                        }
                    }
                    if (submitButton) break;
                }
            }

            if (submitButton) {
                submitButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    submitButton.click();
                    console.log(`âœ… Ø¶ØºØ·Øª Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:`, submitButton.textContent || submitButton.innerText);
                    resolve(true);
                }, 300);
            } else {
                console.error('âŒ Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                resolve(false);
            }
        });
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©
    function selectCurrency(currency = 'USDT') {
        return new Promise((resolve) => {
            console.log(`ğŸ’± Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©: ${currency}`);

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†Øµ (Ù…Ù† Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…)
            let currencyElement = null;
            const elements = Array.from(document.querySelectorAll('*'));
            for (const el of elements) {
                if (el.innerText && el.innerText.trim().toUpperCase() === currency.toUpperCase()) {
                    const section = el.closest('section') || el.closest('div');
                    if (section) {
                        currencyElement = el;
                        break;
                    }
                }
            }

            // Ø¥Ø°Ø§ Ù…Ø§ Ù„Ù‚Ù‰ Ø§Ù„Ø¹Ù…Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ØµØŒ ÙŠØ¬Ø±Ø¨ Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            if (!currencyElement) {
                const currencySelectors = [
                    '[name="currency"]',
                    '[id*="currency"]',
                    '[class*="currency"]',
                    'select[name*="Cur"]',
                    'select[id*="Cur"]',
                    'select'
                ];

                for (let selector of currencySelectors) {
                    const selects = document.querySelectorAll(selector);
                    for (let select of selects) {
                        if (select.offsetParent !== null) {
                            currencyElement = select;
                            break;
                        }
                    }
                    if (currencyElement) break;
                }
            }

            if (currencyElement) {
                currencyElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    currencyElement.click();
                    console.log(`âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©: ${currency}`);
                    resolve(true);
                }, 300);
            } else {
                console.log('âš ï¸ Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§ Ø§Ù„Ø¹Ù…Ù„Ø©ØŒ Ø¨Ù†Ø³Ø§ÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
                resolve(false);
            }
        });
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒÙˆØ¯ (Ù…Ø­Ø³Ù‘Ù†Ø©)
    function processCode(codeData) {
        if (isClaiming) return;

        isClaiming = true;
        updateStatus(`Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒÙˆØ¯: ${codeData.code}`, 'claiming');
        playSound('new_code');

        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
        simulateCodeEntry(codeData.code)
            .then(() => {
                // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡
                return clickSubmitButton();
            })
            .then((success) => {
                if (!success) throw new Error('ÙØ´Ù„ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„');
                // Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø¹Ù„Ø´Ø§Ù† ØªØ¸Ù‡Ø± Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©
                return new Promise(resolve => setTimeout(resolve, 1500));
            })
            .then(() => {
                // Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„Ø©
                return selectCurrency('USDT');
            })
            .then(() => {
                // Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©
                return new Promise(resolve => setTimeout(resolve, 1000));
            })
            .then(() => {
                // Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ (Ø¥Ø°Ø§ Ù„Ø§Ø²Ù…)
                return clickSubmitButton();
            })
            .then(() => {
                // Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ø³ÙŠØ±ÙØ±
                return sendCodeValue(codeData.id, codeData.value || 0, codeData.code);
            })
            .then(() => {
                updateStatus(`âœ… ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯: ${codeData.code}`, 'active');
                addToHistory(codeData.code, codeData.value || 0, 'success');
                playSound('success');
                isClaiming = false;

                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…ÙØ¹Ù„Ø©ØŒ Ù†Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ÙØ­Øµ
                if (autoClaimEnabled) {
                    setTimeout(checkForNewCodes, 1000);
                }
            })
            .catch((error) => {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒÙˆØ¯:', error);
                updateStatus(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯: ${codeData.code}`, 'error');
                addToHistory(codeData.code, codeData.value || 0, 'failed');
                playSound('error');
                isClaiming = false;
            });
    }

    // Turbo Claim - Ù…Ø·Ø§Ù„Ø¨Ø© Ø³Ø±ÙŠØ¹Ø©
    function turboClaim() {
        updateStatus('ğŸš€ Turbo Claim Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„...', 'claiming');
        playSound('new_code');

        // Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø·Ø§Ù„Ø¨Ø© Ø³Ø±ÙŠØ¹Ø©
        setTimeout(() => {
            updateStatus('âœ… Turbo Claim Ø§ÙƒØªÙ…Ù„', 'active');
            playSound('success');
        }, 2000);
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø³ÙŠØ±ÙØ±
    function sendCodeValue(codeId, value, code) {
        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                method: 'POST',
                url: `${SERVER_URL}/api/codes/${codeId}/claim`,
                headers: {
                    'Script-Token': SCRIPT_TOKEN,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    value: value,
                    currency: 'USDT'
                }),
                onload: function(response) {
                    if (response.status === 200) {
                        resolve();
                    } else if (response.status === 401) {
                        updateStatus('Ø§Ø´ØªØ±Ø§Ùƒ ØºÙŠØ± Ù…ÙØ¹Ù„', 'error');
                        playSound('error');
                        alert('âŒ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ØºÙŠØ± Ù…ÙØ¹Ù„ Ø£Ùˆ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡.');
                        reject(new Error('ØºÙŠØ± Ù…ÙØ¹Ù„'));
                    } else {
                        reject(new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯'));
                    }
                },
                onerror: function(error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙˆØ¯:', error);
                    reject(error);
                }
            });
        });
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    function waitForPageLoad() {
        return new Promise((resolve) => {
            if (document.readyState === 'complete') {
                resolve();
            } else {
                window.addEventListener('load', resolve);
            }
        });
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    async function init() {
        try {
            // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
            await waitForPageLoad();

            // Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            await new Promise(resolve => setTimeout(resolve, 1500));

            createTopBarStyles();
            createTopToolbar();    // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ
            createHistoryPanel();  // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø³Ø¬Ù„

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ù…Ø²
            validateToken()
                .then(() => {
                    updateStatus('Ù…ØªØµÙ„ ÙˆÙ…ÙØ¹Ù„', 'active');
                    playSound('success');

                    // Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…ÙØ¹Ù„Ø©
                    setInterval(() => {
                        if (autoClaimEnabled) {
                            checkForNewCodes();
                        }
                    }, 3000);

                    // ÙØ­Øµ ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    setTimeout(checkForNewCodes, 1000);

                    console.log('ğŸ¯ Stake Code Claimer Top Bar ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­');
                })
                .catch((error) => {
                    updateStatus('ØºÙŠØ± Ù…ÙØ¹Ù„', 'error');
                    playSound('error');
                    alert(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª: ${error.message}\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø´ØªØ±Ø§ÙƒÙƒ.`);
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²:', error);
                });
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø³ÙƒØ±Ø¨Øª:', error);
        }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± ØµØºÙŠØ± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    setTimeout(init, 2500);

})();